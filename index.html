<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>El Misterio del Festival de Avatares</title>
<style>
  :root{
    --bg:#0e1226;
    --panel:#12183a;
    --panel-2:#0b1030;
    --accent:#00c2ff;
    --accent-2:#ffd400;
    --safe:#1bd97c;
    --danger:#ff3b57;
    --text:#eaf2ff;
    --muted:#b3c0ff;
    --shadow:0 8px 24px rgba(0,0,0,.35);
    --radius:16px;
  }
  html,body{height:100%;background:radial-gradient(1200px 700px at 20% 0%,#1a2161 0%, #0a0f29 40%, #070a1d 100%); color:var(--text); font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Color Emoji", "Apple Color Emoji", "Twemoji Mozilla", sans-serif; margin:0}
  #app{display:grid;grid-template-rows:auto 1fr auto; height:100%}
  header{
    display:flex; gap:14px; align-items:center; padding:10px 14px;
    background:linear-gradient(90deg, rgba(0,194,255,.15), rgba(255,212,0,.06));
    border-bottom:1px solid rgba(255,255,255,.1);
    position:relative;
  }
  header h1{font-size: clamp(18px,2.4vw,28px); margin:0; letter-spacing:.3px}
  .badge{padding:6px 10px; background:rgba(0,194,255,.18); border:1px solid rgba(0,194,255,.45); border-radius:999px; font-size:12px}
  #mission{flex:1; min-width:160px; font-size:14px; color:var(--muted)}
  #main{display:grid; grid-template-columns: 280px 1fr 280px; gap:12px; padding:12px}
  @media (max-width: 1100px){ #main{grid-template-columns: 1fr; grid-template-rows:auto 1fr auto} #left,#right{order: -1} }
  #left, #right{
    background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
    border:1px solid rgba(255,255,255,.08);
    border-radius:var(--radius);
    box-shadow: var(--shadow);
    padding:12px;
    overflow:auto;
  }
  #canvasWrap{
    position:relative; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border:1px solid rgba(255,255,255,.08); border-radius:var(--radius);
    box-shadow: var(--shadow);
    display:grid; place-items:center; min-height:320px;
  }
  canvas{border-radius:12px; background:#14204d; width:100%; height:100%}
  .panelTitle{font-weight:700; margin:4px 0 6px 0; display:flex; align-items:center; gap:8px}
  .panelTitle .dot{width:8px; height:8px; border-radius:50%; background:var(--accent)}
  .card{
    border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.05);
    border-radius:12px; padding:10px; margin:8px 0
  }
  .token{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; margin:6px 6px 0 0;
    border:1px dashed rgba(255,255,255,.15); font-size:13px; background:rgba(10,15,40,.6)}
  .token.safe{border-color:rgba(27,217,124,.6); background:rgba(27,217,124,.12)}
  .token.danger{border-color:rgba(255,59,87,.6); background:rgba(255,59,87,.12)}
  .big{
    font-size: clamp(18px,2.2vw,22px);
  }
  .controls{display:flex; flex-wrap:wrap; gap:8px; margin-top:6px}
  button{
    appearance:none; border:0; border-radius:12px; padding:10px 12px;
    font-weight:700; color:#071129; background:var(--accent);
    cursor:pointer; box-shadow:0 3px 0 rgba(0,0,0,.35);
  }
  button.secondary{background:#7aa3ff}
  button.ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.2)}
  button.danger{background:var(--danger); color:white}
  button.safe{background:var(--safe); color:black}
  button.icon{display:inline-flex; align-items:center; gap:8px; font-size:14px}
  .kbd{
    background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.2); border-bottom-width:3px;
    padding:2px 6px; border-radius:6px; font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:#cfe2ff
  }
  .hud{
    position:absolute; left:10px; bottom:10px; display:flex; gap:8px; flex-wrap:wrap;
  }
  .hud .pill{
    display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:rgba(0,0,0,.35); backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.15); font-size:13px
  }
  .legend{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px}
  .legend .key{display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); font-size:12px}
  .led{width:12px; height:12px; border-radius:50%}
  .led.safe{background:var(--safe); box-shadow:0 0 12px var(--safe)}
  .led.danger{background:var(--danger); box-shadow:0 0 12px var(--danger)}
  .led.neutral{background:var(--accent-2); box-shadow:0 0 12px var(--accent-2)}
  .dialog{
    position:absolute; inset:auto 10px 10px 10px; padding:10px; border-radius:12px;
    background:linear-gradient(180deg, rgba(10,16,45,.92), rgba(10,16,45,.8));
    border:1px solid rgba(255,255,255,.12); display:none; box-shadow: var(--shadow)
  }
  .dialog.show{display:block}
  .dialog .name{font-weight:800}
  .dialog .speech{margin:6px 0 8px 0}
  .dialog .choices{display:flex; gap:8px; flex-wrap:wrap}
  .sr-only{position:absolute !important; height:1px; width:1px; overflow:hidden; clip:rect(1px,1px,1px,1px); white-space:nowrap}
  .popups{position:absolute; inset:0; pointer-events:none}
  .popup{
    position:absolute; width: min(320px, 70vw); border-radius:10px; background:white; color:#111; padding:10px; border:3px solid #ff3b57;
    transform: rotate(-2deg); filter: drop-shadow(0 14px 30px rgba(0,0,0,.5));
  }
  .popup h4{margin:0 0 4px 0}
  .popup b{color:#ff3b57}
  .winner, .loser{
    position:absolute; inset:0; display:none; place-items:center; background:rgba(0,0,0,.65);
  }
  .winner.show, .loser.show{display:grid}
  .modalCard{
    max-width:860px; margin:0 12px; border-radius:18px; background:linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid rgba(255,255,255,.12); box-shadow:var(--shadow); padding:18px
  }
  /* On-screen DPad for touch */
  #dpad{
    position:absolute; left:12px; bottom:12px; display:grid; grid-template-columns:repeat(3,52px); grid-auto-rows:52px; gap:6px;
    opacity:.9
  }
  #dpad button{border-radius:10px; background:rgba(255,255,255,.1); color:var(--text); border:1px solid rgba(255,255,255,.2); font-weight:900}
  #dpad .blank{visibility:hidden}
  /* Avatar customization */
  .customize{display:flex; gap:8px; flex-wrap:wrap}
  select{background:#0d1440; border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:8px; color:var(--text)}
  /* Progress dots */
  .steps{display:flex; gap:6px; margin-top:6px}
  .steps .dot{width:10px; height:10px; border-radius:50%; background:#3b4aa1; opacity:.5}
  .steps .dot.on{opacity:1; box-shadow:0 0 0 3px rgba(0,194,255,.25)}
</style>
</head>
<body>
<div id="app" role="application" aria-label="El Misterio del Festival de Avatares">
  <header>
    <span class="badge">üé≠ Festival en l√≠nea</span>
    <h1>El Misterio del Festival de Avatares</h1>
    <div id="mission">Objetivo: aprende a reconocer interacciones <b>seguras</b> y <b>peligrosas</b>, usando la <b>Lupa de la Verdad</b> üîç y el <b>Bot√≥n de Alerta</b> üö®.</div>
  </header>

  <div id="main" aria-live="polite">
    <!-- LEFT: Training & Manual -->
    <aside id="left" aria-label="Panel de entrenamiento y manual">
      <div class="panelTitle"><span class="dot"></span>Jefa de Seguridad üë©‚Äç‚úàÔ∏è</div>
      <div class="card big" id="trainingCard">
        <div><b>Misi√≥n:</b> Detective, hoy atrapar√°s al <b>Impostor Digital</b>. Primero aprende estas 3 se√±ales de riesgo:</div>
        <div class="legend">
          <div class="key"><span class="led danger"></span> <b>Prisa</b> ‚Äî ‚Äú¬°R√°pido, responde ya!‚Äù</div>
          <div class="key"><span class="led danger"></span> <b>Premio M√°gico</b> ‚Äî ‚Äú¬°Ganaste un celular!‚Äù</div>
          <div class="key"><span class="led danger"></span> <b>Enlace Misterioso</b> ‚Äî ‚ÄúHaz clic aqu√≠‚Äù</div>
        </div>
        <div class="controls">
          <button id="btnStart" class="icon safe">üé¨ Empezar entrenamiento</button>
          <button id="btnNarrate" class="icon secondary">üîä Narrar</button>
        </div>
        <div class="steps" aria-label="Progreso">
          <div class="dot on" id="stepDot1"></div>
          <div class="dot" id="stepDot2"></div>
          <div class="dot" id="stepDot3"></div>
          <div class="dot" id="stepDot4"></div>
        </div>
      </div>

      <div class="panelTitle" style="margin-top:10px;"><span class="dot"></span>Manual de Pistas üìí</div>
      <div class="card">
        <div id="tokens"></div>
        <small style="color:var(--muted)">Colecciona las <i>Fichas de Pistas</i> al detectar se√±ales. ¬°Re√∫ne las 3!</small>
      </div>

      <div class="panelTitle" style="margin-top:10px;"><span class="dot"></span>Tu Avatar üïµÔ∏è</div>
      <div class="card">
        <div class="customize" aria-label="Personalizaci√≥n de avatar">
          <label>Sombrero
            <select id="hatSel" aria-label="Sombrero">
              <option value="none">Sin sombrero</option>
              <option value="üé©">üé© Sombrero alto</option>
              <option value="üß¢">üß¢ Gorra</option>
              <option value="‚õëÔ∏è">‚õëÔ∏è Casco</option>
            </select>
          </label>
          <label>Gabardina
            <select id="coatSel" aria-label="Gabardina">
              <option value="none">Sin gabardina</option>
              <option value="üü¶">üü¶ Azul</option>
              <option value="üü´">üü´ Caf√©</option>
              <option value="‚¨õ">‚¨õ Negra</option>
            </select>
          </label>
          <label>Lupa
            <select id="lensSel" aria-label="Lupa">
              <option value="üîç">üîç Cl√°sica</option>
              <option value="üîé">üîé Zoom</option>
              <option value="üß™">üß™ Cient√≠fica</option>
            </select>
          </label>
        </div>
      </div>
    </aside>

    <!-- CENTER: Game world -->
    <section id="canvasWrap" aria-label="√Årea del festival">
      <canvas id="world" width="900" height="520" role="img" aria-label="Escena del festival con avatares y decoraciones"></canvas>

      <div class="hud" aria-hidden="true">
        <div class="pill">Mover: <span class="kbd">W</span> <span class="kbd">A</span> <span class="kbd">S</span> <span class="kbd">D</span> / Flechas</div>
        <div class="pill">Interactuar: <span class="kbd">E</span></div>
        <div class="pill">Lupa de la Verdad: <span class="kbd">L</span> üîç</div>
        <div class="pill">Bot√≥n de Alerta: <span class="kbd">B</span> üö®</div>
      </div>

      <div id="dpad" aria-label="Control t√°ctil" aria-hidden="false">
        <button data-dx="0" data-dy="-1">‚ñ≤</button>
        <button class="blank"></button>
        <button data-dx="0" data-dy="1">‚ñº</button>
        <button data-dx="-1" data-dy="0">‚óÄ</button>
        <button class="blank"></button>
        <button data-dx="1" data-dy="0">‚ñ∂</button>
        <button id="btnE">Hablar (E)</button>
        <button id="btnL">Lupa (L)</button>
        <button id="btnB" class="danger">Alerta (B)</button>
      </div>

      <!-- Dialog bubble -->
      <div class="dialog" id="dialog" role="dialog" aria-modal="false" aria-live="polite">
        <div class="name" id="dName">Nombre</div>
        <div class="speech" id="dText">‚Ä¶</div>
        <div class="choices">
          <button id="dClose" class="ghost">Cerrar</button>
          <button id="dLink" class="secondary">Abrir enlace</button>
          <button id="dAnalyze" class="icon safe">üîç Analizar</button>
        </div>
      </div>

      <!-- Fake popups for dangerous click -->
      <div class="popups" id="popups" aria-hidden="true"></div>

      <!-- Victory / Defeat overlays -->
      <div class="winner" id="win">
        <div class="modalCard">
          <h2>üèÜ ¬°Misi√≥n cumplida!</h2>
          <p>La Jefa atrap√≥ al impostor en una <b>burbuja protectora</b>. ¬°Excelente decisi√≥n al usar el <b>Bot√≥n de Alerta</b>! üö®</p>
          <div class="legend">
            <div class="key"><span class="led safe"></span> Aprendizaje: <b>Pedir ayuda protege a todos.</b></div>
            <div class="key"><span class="led safe"></span> Nuevos casos disponibles con pistas m√°s sutiles.</div>
          </div>
          <div class="controls">
            <button id="btnReplay" class="icon">üîÅ Jugar de nuevo</button>
            <button id="btnHarder" class="icon secondary">üß© Nuevo caso</button>
            <button id="btnNarrateWin" class="icon ghost">üîä Reproducir voz</button>
          </div>
        </div>
      </div>

      <div class="loser" id="lose">
        <div class="modalCard">
          <h2>üòµ ¬°Oh, no! Ca√≠mos en la trampa</h2>
          <p>Revisemos las se√±ales: <b>Prisa</b>, <b>Premio M√°gico</b> y <b>Enlace Misterioso</b>. ¬°Intenta de nuevo!</p>
          <div class="controls">
            <button id="btnRetry" class="icon safe">üîÅ Reintentar</button>
            <button id="btnNarrateLose" class="icon ghost">üîä Reproducir voz</button>
          </div>
        </div>
      </div>
    </section>

    <!-- RIGHT: Tools -->
    <aside id="right" aria-label="Herramientas y accesibilidad">
      <div class="panelTitle"><span class="dot"></span>Herramientas del Detective</div>
      <div class="card">
        <div class="controls">
          <button id="btnLens" class="icon">üîç Lupa de la Verdad</button>
          <button id="btnAlert" class="icon danger">üö® Bot√≥n de Alerta</button>
        </div>
        <div class="legend" style="margin-top:10px">
          <div class="key"><span class="led safe"></span> Seguro</div>
          <div class="key"><span class="led danger"></span> Peligro</div>
          <div class="key"><span class="led neutral"></span> Desconocido</div>
        </div>
      </div>

      <div class="panelTitle" style="margin-top:10px;"><span class="dot"></span>Accesibilidad</div>
      <div class="card">
        <div class="controls">
          <button id="voiceOn" class="icon">üó£Ô∏è Narraci√≥n ON</button>
          <button id="voiceOff" class="icon ghost">üîá Narraci√≥n OFF</button>
        </div>
        <small style="color:var(--muted)">La narraci√≥n usa la voz del navegador (no requiere internet). Tambi√©n hay sonidos y vibraci√≥n (si el dispositivo lo permite).</small>
      </div>

      <div class="panelTitle" style="margin-top:10px;"><span class="dot"></span>Estado</div>
      <div class="card">
        <div><b>Fase:</b> <span id="phase">Entrenamiento</span></div>
        <div><b>Se√±ales detectadas:</b> <span id="foundCount">0/3</span></div>
        <div><b>√çndice de Seguridad:</b> <span id="sIndex">Neutral</span></div>
      </div>
    </aside>
  </div>

  <footer style="padding:8px 14px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; align-items:center">
    <div>¬© Gnius Club ‚Äî <b>Detective de la Verdad</b> en el Festival de Avatares</div>
    <div>Consejos: Desconf√≠a de la prisa, premios m√°gicos y enlaces misteriosos. ¬°Pide ayuda!</div>
  </footer>
</div>

<!-- Screen reader live region -->
<div class="sr-only" aria-live="assertive" id="aria"></div>

<script>
/* =========================
   UTIL: Narraci√≥n + Audio
   ========================= */
const say = (text, opts={})=>{
  if(!state.voiceEnabled) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'es-MX';
  u.rate = opts.rate ?? 1.0;
  u.pitch = opts.pitch ?? 1.0;
  speechSynthesis.cancel(); // avoid queue overflow
  speechSynthesis.speak(u);
};
const buzz = (ms=80)=>{ if(navigator.vibrate){ try{ navigator.vibrate(ms);}catch{} } };

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
const tone = (freq=660, dur=0.15, type='sine', gain=0.06)=>{
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.setValueAtTime(gain, audioCtx.currentTime);
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
};
const sfx = {
  confirm(){ tone(880, .1,'sine',.08); tone(1320,.08,'sine',.06); },
  clue(){ tone(523,.08,'triangle',.08); setTimeout(()=>tone(784,.12,'triangle',.08),90); },
  success(){ tone(392,.1,'sine',.1); setTimeout(()=>tone(523,.12,'sine',.1),120); setTimeout(()=>tone(659,.16,'sine',.1),260); },
  danger(){ tone(110,.12,'square',.12); setTimeout(()=>tone(98,.12,'square',.12),150); },
};

/* =========================
   GAME STATE
   ========================= */
const state = {
  phase: 'training',  // training ‚Üí interrogations ‚Üí final ‚Üí win/lose
  voiceEnabled: true,
  foundSignals: new Set(),
  securityIndex: 'Neutral',
  harder: false,
  player: {x: 130, y: 260, r: 18, speed: 3, hat:'none', coat:'none', lens:'üîç'},
  npcs: [],
  activeNPC: null,
  linkOpenDanger:false
};

const phasesText = {
  training: "Entrenamiento",
  interrogations: "Interrogatorios",
  final: "Desaf√≠o final",
  win: "Victoria",
  lose: "Derrota"
};

/* =========================
   WORLD & AVATARS (Canvas)
   ========================= */
const canvas = document.getElementById('world');
const ctx = canvas.getContext('2d');

function rand(min,max){ return Math.random()*(max-min)+min; }

function buildNPCs(){
  // Two main avatars + ambience
  const friendlyLink = state.harder ? "https://biblioteca-escolar.local/seguridad" : "https://museo-virtual.local/fiesta";
  const impostorMsgVariants = state.harder
    ? [
        {text:"¬°R√ÅPIDO! Necesito tu contrase√±a para validar tu premio sorpresa üéÅ", flags:['Prisa','Premio']},
        {text:"¬°Ganaste un pase VIP! Solo confirma tus datos y haz clic aqu√≠ üëâ bit.ly/vip-123", flags:['Premio','Enlace']},
        {text:"Se detect√≥ un error en tu cuenta. Verifica YA aqu√≠: check-secure-login.xyz", flags:['Prisa','Enlace']}
      ]
    : [
        {text:"¬°Ganaste un premio m√°gico! Haz clic aqu√≠: premio-festival.win", flags:['Premio','Enlace']},
        {text:"R√°pido, dame tu contrase√±a para evitar un bloqueo üîí", flags:['Prisa']},
      ];
  const impostorMsg = impostorMsgVariants[Math.floor(Math.random()*impostorMsgVariants.length)];

  state.npcs = [
    {
      id:'ally', name:'Jefa de Seguridad', role:'ally', color:'#7ee3ff', x: 120, y: 120,
      lines:[
        "Detective, recuerda: desconf√≠a de la prisa, de premios m√°gicos y de enlaces misteriosos.",
        "Usa la Lupa de la Verdad üîç para analizar mensajes. Si dudas, ¬°presiona el Bot√≥n de Alerta! üö®"
      ]
    },
    {
      id:'friend', name:'Avatar Amistoso', role:'friend', color:'#89ff9f', x: 540, y: 140,
      link:friendlyLink,
      text:"¬°Hola! ¬øVisitamos juntos la galer√≠a segura del festival? Aqu√≠ est√° el enlace con candado.",
      safe:true
    },
    {
      id:'myst', name:'Avatar Misterioso', role:'impostor', color:'#ff9e9e', x: 680, y: 360,
      link:"http://premio-misterioso-win.xyz",
      text: impostorMsg.text,
      flags: impostorMsg.flags,
      safe:false
    },
    // decorative crowd
    ...Array.from({length:10}).map((_,i)=>({
      id:'crowd'+i, name:'Asistente', role:'crowd', color:['#ffd27e','#b1a8ff','#7efff1','#ffc1f1','#a6ff7e'][i%5],
      x: rand(60,840), y: rand(70,460)
    }))
  ];
}

function drawConfetti(){
  for(let i=0;i<140;i++){
    const x = (i*37 % canvas.width), y = (i*17 % canvas.height);
    ctx.fillStyle = ['#ffec6e','#6ee7ff','#ff8ab7','#9bff7a','#c5a6ff'][i%5];
    ctx.beginPath(); ctx.arc(x, (y + (Date.now()/30 + i)%canvas.height)%canvas.height, 2, 0, Math.PI*2); ctx.fill();
  }
}
function drawDecor(){
  // bunting flags
  for(let i=0;i<16;i++){
    const x = 40 + i*52, y = 36 + Math.sin((Date.now()/500)+i)*4;
    ctx.fillStyle = ['#ff6b6b','#ffd93d','#6bcBff','#7bff9e'][i%4];
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x+24,y+10); ctx.lineTo(x+12,y+28); ctx.closePath(); ctx.fill();
  }
  // stage
  ctx.fillStyle='#1a2a63'; roundedRect(340, 430, 220, 60, 12, true);
  ctx.fillStyle='#2c3e8f'; roundedRect(360, 440, 180, 40, 10, true);
  // lanterns
  for(let i=0;i<6;i++){
    const x = 120 + i*120, y = 80 + Math.sin((Date.now()/400)+i)*6;
    ctx.fillStyle = ['#ffd400','#00c2ff','#ff66a6'][i%3];
    ctx.beginPath(); ctx.arc(x,y,10,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,.2)'; ctx.fillRect(x-1,y+10,2,14);
  }
}
function roundedRect(x,y,w,h,r,fill){
  ctx.beginPath();
  ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath();
  if(fill) ctx.fill(); else ctx.stroke();
}

function render(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // floor gradient
  const g = ctx.createLinearGradient(0,0,0,canvas.height);
  g.addColorStop(0,'#0c1552'); g.addColorStop(1,'#0a1039');
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

  drawConfetti(); drawDecor();

  // NPCs
  for(const n of state.npcs){
    // body
    ctx.fillStyle=n.color;
    roundedRect(n.x-18,n.y-18,36,36,8,true);
    // eyes
    ctx.fillStyle='#081033';
    ctx.beginPath(); ctx.arc(n.x-6,n.y-4,3,0,Math.PI*2); ctx.arc(n.x+6,n.y-4,3,0,Math.PI*2); ctx.fill();
    // name tag
    ctx.fillStyle='rgba(255,255,255,.2)'; roundedRect(n.x-26,n.y+22,52,14,6,true);
  }

  // Player
  const p = state.player;
  // coat aura
  if(p.coat && p.coat!=='none'){ ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.lineWidth=8; ctx.beginPath(); ctx.arc(p.x,p.y,p.r+8,0,Math.PI*2); ctx.stroke(); }
  ctx.fillStyle='#ffeaa7'; roundedRect(p.x-p.r, p.y-p.r, p.r*2, p.r*2, 8, true);
  // face
  ctx.fillStyle='#0a1236';
  ctx.beginPath(); ctx.arc(p.x-6,p.y-4,3,0,Math.PI*2); ctx.arc(p.x+6,p.y-4,3,0,Math.PI*2); ctx.fill();
  // hat emoji
  if(p.hat && p.hat!=='none'){ ctx.font='20px serif'; ctx.fillText(p.hat, p.x-10, p.y-22); }
  // coat block
  if(p.coat && p.coat!=='none'){ ctx.font='18px serif'; ctx.fillText(p.coat, p.x-8, p.y+30); }
  // lens on hip
  ctx.font='20px serif'; ctx.fillText(p.lens, p.x+16, p.y+6);

  // HUD icons near player
  ctx.font='12px system-ui'; ctx.fillStyle='rgba(255,255,255,.8)';
  ctx.fillText('Detective', p.x-24, p.y-22);

  // indicators around friend/impostor
  const imp = state.npcs.find(n=>n.role==='impostor');
  const frn = state.npcs.find(n=>n.role==='friend');
  if(imp){ ctx.strokeStyle='rgba(255,59,87,.6)'; ctx.setLineDash([6,6]); ctx.strokeRect(imp.x-26,imp.y-26,52,52); ctx.setLineDash([]); }
  if(frn){ ctx.strokeStyle='rgba(27,217,124,.6)'; ctx.strokeRect(frn.x-26,frn.y-26,52,52); }

  requestAnimationFrame(render);
}

/* =========================
   INPUT & MOVEMENT
   ========================= */
const keys = {};
document.addEventListener('keydown', (e)=>{
  keys[e.key.toLowerCase()] = true;
  if(e.key.toLowerCase()==='e'){ interact(); }
  if(e.key.toLowerCase()==='l'){ analyze(); }
  if(e.key.toLowerCase()==='b'){ alertButton(); }
});
document.addEventListener('keyup', (e)=>{ keys[e.key.toLowerCase()] = false; });

function loop(){
  const p = state.player;
  let dx = 0, dy = 0;
  if(keys['arrowup']||keys['w']) dy-=1;
  if(keys['arrowdown']||keys['s']) dy+=1;
  if(keys['arrowleft']||keys['a']) dx-=1;
  if(keys['arrowright']||keys['d']) dx+=1;
  const sp = p.speed;
  p.x = Math.max(30, Math.min(canvas.width-30, p.x + dx*sp));
  p.y = Math.max(50, Math.min(canvas.height-30, p.y + dy*sp));
  // proximity dialog auto-hint
  const near = nearestNPC();
  if(near && dist(p,near) < 54){
    showHint(`${near.name}: presiona E para hablar`);
  } else { showHint(''); }
  requestAnimationFrame(loop);
}
function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
function nearestNPC(){
  let best=null, d=1e9;
  for(const n of state.npcs){
    const dd = dist(state.player, n);
    if(dd<d){ d=dd; best=n; }
  }
  return best;
}

/* =========================
   DIALOG & ANALYSIS
   ========================= */
const dialog = document.getElementById('dialog');
const dName = document.getElementById('dName');
const dText = document.getElementById('dText');
const dClose = document.getElementById('dClose');
const dAnalyze = document.getElementById('dAnalyze');
const dLink = document.getElementById('dLink');

function interact(){
  const n = nearestNPC(); if(!n || dist(state.player,n) > 70) return;
  state.activeNPC = n;
  dialog.classList.add('show');
  dName.textContent = n.name + (n.role==='impostor'?' (¬øsospechoso?)':'');
  if(n.role==='ally'){
    dText.textContent = n.lines[Math.floor(Math.random()*n.lines.length)];
    dLink.style.display='none';
  }else if(n.role==='friend'){
    dText.textContent = n.text + " üîí";
    dLink.style.display='inline-block'; dLink.dataset.href = n.link; dLink.textContent="Abrir enlace seguro";
  }else if(n.role==='impostor'){
    dText.textContent = n.text + " ‚ö†Ô∏è";
    dLink.style.display='inline-block'; dLink.dataset.href = n.link; dLink.textContent="Abrir enlace (riesgo)";
  }else{
    dText.textContent = "¬°Qu√© bonito festival!";
    dLink.style.display='none';
  }
  say(`${n.name} dice: ${stripEmoji(dText.textContent)}`, {rate:1.05});
}
dClose.onclick = ()=> dialog.classList.remove('show');
dAnalyze.onclick = analyze;
dLink.onclick = ()=>{
  const href = dLink.dataset.href || '#';
  const npc = state.activeNPC;
  if(npc?.safe){
    sfx.confirm(); say("¬°Bien investigado! Interacci√≥n segura."); buzz(30);
    addToken('Candado seguro', 'safe', 'üîí');
  }else if(npc?.role==='impostor'){
    // simulate annoying popups
    showFakePopups();
    sfx.danger(); say("¬°Oh, no! Ca√≠mos en la trampa.");
    setTimeout(()=>defeat(), 900);
  }
};

function stripEmoji(t){ return t.replace(/[\p{Extended_Pictographic}\p{Emoji_Presentation}]/gu,''); }

function analyze(){
  const n = state.activeNPC || nearestNPC();
  if(!n){ flashAria("Ac√©rcate a un avatar para usar la Lupa."); return; }
  if(dist(state.player,n) > 90){ flashAria("Est√°s lejos. Ac√©rcate para analizar."); return; }
  if(n.role==='friend'){
    showLensResult(true, "¬°An√°lisis seguro! Enlace con candado.");
    sfx.confirm(); say("¬°Bien investigado! Interacci√≥n segura.");
    addToken('Candado seguro', 'safe', 'üîí');
  }else if(n.role==='impostor'){
    showLensResult(false, "¬°Peligro! Se√±ales detectadas: " + (n.flags?.join(', ') || 'sospechoso'));
    sfx.clue(); say("¬°Tu instinto de detective es agudo!");
    (n.flags||[]).forEach(f=> addSignal(f));
  }else if(n.role==='ally'){
    sfx.confirm(); say("Recuerda: si dudas, presiona el Bot√≥n de Alerta.");
  }
}

function addSignal(name){
  const map = {'Prisa':'‚è±Ô∏è','Premio':'üéÅ','Enlace':'üß©'};
  const key = name.includes('Prisa')?'Prisa':name.includes('Premio')?'Premio M√°gico':'Enlace Misterioso';
  state.foundSignals.add(key);
  addToken(key, 'danger', map[name.includes('Prisa')?'Prisa':name.includes('Premio')?'Premio':'Enlace'] || '‚ò†Ô∏è');
  updateUI();
  // progress to final when player has interacted with both avatars
  const metFriend = met('friend'), metImpostor = met('impostor');
  if(metFriend && metImpostor && state.phase!=='final'){
    state.phase='final'; updateUI();
    say("Desaf√≠o final: puedes acusar al impostor o presionar el Bot√≥n de Alerta. La mejor decisi√≥n es pedir ayuda.");
    // guide
    flashAria("¬°Desaf√≠o final! Usa üö® para pedir ayuda.");
  }
}
function met(role){
  return !!state.foundSignals.size || role==='friend' ? true : false;
}

function showLensResult(isSafe, text){
  const pill = document.createElement('div');
  pill.className='pill'; pill.style.position='absolute'; pill.style.right='10px'; pill.style.top='10px';
  pill.style.border = '1px solid rgba(255,255,255,.2)';
  pill.innerHTML = (isSafe ? 'üü¢üîí' : '‚ò†Ô∏èüî¥') + '&nbsp; ' + text;
  document.getElementById('canvasWrap').appendChild(pill);
  setTimeout(()=> pill.remove(), 1600);
}

function showFakePopups(){
  const area = document.getElementById('popups'); area.innerHTML=''; area.style.pointerEvents='none';
  for(let i=0;i<6;i++){
    const p = document.createElement('div'); p.className='popup';
    p.style.left = Math.round(rand(10, 60))+'%'; p.style.top = Math.round(rand(10, 60))+'%';
    p.innerHTML = `<h4>üéÅ <b>¬°PREMIO M√ÅGICO!</b></h4><p>¬°Hiciste clic! Descarga aqu√≠: <b>win-fast.exe</b></p>`;
    area.appendChild(p);
  }
}

function alertButton(){
  if(state.phase!=='final'){
    say("Buena idea: si dudas, reporta. Sigue investigando primero."); sfx.confirm(); return;
  }
  // Win path
  victory();
}

function victory(){
  document.getElementById('win').classList.add('show');
  bubbleImpostor();
  sfx.success();
  say("¬°La mejor decisi√≥n! Reportar protege a todos.");
}
function defeat(){
  document.getElementById('lose').classList.add('show');
}
function bubbleImpostor(){
  const imp = state.npcs.find(n=>n.role==='impostor'); if(!imp) return;
  const steps = 28;
  let t=0; const id = setInterval(()=>{
    ctx.beginPath(); ctx.strokeStyle='rgba(0,194,255,.8)'; ctx.lineWidth=3;
    ctx.arc(imp.x, imp.y, 30 + (t%12), 0, Math.PI*2); ctx.stroke(); t++; if(t>steps) clearInterval(id);
  }, 40);
}

/* =========================
   UI helpers
   ========================= */
const aria = document.getElementById('aria');
function flashAria(text){ aria.textContent=''; setTimeout(()=>aria.textContent=text, 10); }

const tokens = document.getElementById('tokens');
function addToken(text, kind='danger', icon='üîñ'){
  const el = document.createElement('span'); el.className = 'token ' + (kind==='danger'?'danger':'safe');
  el.innerHTML = `${icon}&nbsp; ${text}`;
  tokens.appendChild(el);
}

function updateUI(){
  document.getElementById('phase').textContent = phasesText[state.phase] || state.phase;
  document.getElementById('foundCount').textContent = `${state.foundSignals.size}/3`;
  const idx = state.foundSignals.size===0?'Neutral':(state.foundSignals.size>=2?'Alerta':'Precauci√≥n');
  state.securityIndex = idx;
  document.getElementById('sIndex').textContent = idx;

  // progress dots
  document.getElementById('stepDot1').classList.toggle('on', state.phase==='training');
  document.getElementById('stepDot2').classList.toggle('on', state.phase==='interrogations');
  document.getElementById('stepDot3').classList.toggle('on', state.phase==='final');
  document.getElementById('stepDot4').classList.toggle('on', state.phase==='win' || state.phase==='lose');
}

/* =========================
   SETUP & REPLAY
   ========================= */
function startTraining(){
  state.phase='interrogations'; updateUI();
  sfx.confirm();
  say("Entrenamiento listo. Busca al Avatar Amistoso y al Avatar Misterioso para investigar.");
}

function reset(harder=false){
  state.phase='training'; state.harder = !!harder;
  state.foundSignals = new Set();
  state.player.x=130; state.player.y=260;
  tokens.innerHTML='';
  buildNPCs(); updateUI();
  document.getElementById('win').classList.remove('show');
  document.getElementById('lose').classList.remove('show');
  document.getElementById('popups').innerHTML='';
  say("Bienvenido, Detective de la Verdad. Yo soy la Jefa de Seguridad. Te ense√±ar√© a detectar se√±ales de riesgo.");
}

function personalize(){
  const hat = document.getElementById('hatSel').value;
  const coat = document.getElementById('coatSel').value;
  const lens = document.getElementById('lensSel').value;
  state.player.hat = hat; state.player.coat = coat; state.player.lens = lens;
}

document.getElementById('btnStart').onclick= startTraining;
document.getElementById('btnNarrate').onclick= ()=> say("Se√±ales de riesgo: Prisa, Premio M√°gico y Enlace Misterioso. √ösalas para protegerte.");
document.getElementById('btnLens').onclick= analyze;
document.getElementById('btnAlert').onclick= alertButton;
document.getElementById('voiceOn').onclick = ()=>{ state.voiceEnabled=true; say("Narraci√≥n activada."); sfx.confirm(); };
document.getElementById('voiceOff').onclick = ()=>{ state.voiceEnabled=false; sfx.danger(); buzz(40); };
document.getElementById('btnReplay').onclick = ()=> reset(false);
document.getElementById('btnHarder').onclick = ()=> reset(true);
document.getElementById('btnNarrateWin').onclick = ()=> say("¬°La mejor decisi√≥n! Reportar protege a todos.");
document.getElementById('btnNarrateLose').onclick = ()=> say("Oh no. Ca√≠mos en la trampa. Repasemos las se√±ales y volvamos a intentarlo.");
document.getElementById('btnRetry').onclick = ()=> reset(state.harder);

['hatSel','coatSel','lensSel'].forEach(id=>{
  document.getElementById(id).addEventListener('change', personalize);
});

document.getElementById('btnE').onclick = interact;
document.getElementById('btnL').onclick = analyze;
document.getElementById('btnB').onclick = alertButton;

// Touch dpad
document.querySelectorAll('#dpad button[data-dx]').forEach(btn=>{
  const dx = parseInt(btn.dataset.dx,10), dy = parseInt(btn.dataset.dy,10);
  const press = ()=>{ state.player.x += dx*18; state.player.y += dy*18; buzz(12); };
  btn.addEventListener('click', press);
});

/* =========================
   INIT
   ========================= */
buildNPCs(); updateUI(); render(); loop();
reset(false);

/* Accessibility hint HUD */
let hintTimeout=null;
function showHint(text){
  if(hintTimeout) clearTimeout(hintTimeout);
  if(!text){ flashAria(''); return; }
  flashAria(text);
  hintTimeout = setTimeout(()=>flashAria(''), 1500);
}

/* =========================
   FINAL CHALLENGE UI (accuse vs alert)
   =========================
   We steer the player via narration and HUD. If they try to "acusar",
   we redirect to the safer choice but still allow learning.
*/
</script>
</body>
</html>
